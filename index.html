<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AZawPulf_LA1GNqlqUE_L6PC4UqJsan33_c5L9wEcOLTRK1itpzK1QrSwueuFyPlbaEV7U0JejX_Vd70&currency=GBP"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 10px; position: relative; }
        
        /* OVERRIDE: Forced Top Notification */
        #msgNotification {
            position: fixed !important; 
            top: 20px !important; 
            left: 50% !important; 
            transform: translateX(-50%) !important;
            background: #76ff03 !important; 
            color: #1a2e0e !important; 
            padding: 12px 25px !important; 
            border-radius: 50px !important;
            font-weight: 900 !important; 
            font-size: 1.2rem !important; 
            z-index: 9999999 !important; /* Maximum possible depth */
            display: none;
            box-shadow: 0 0 20px rgba(118, 255, 3, 0.6), 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            border: 3px solid #fff !important;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: translateX(-50%) scale(0.5); opacity: 0; } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }

        /* Rest of UI */
        .top-status-bar { background: rgba(0, 0, 0, 0.8); border-bottom: 2px solid #4caf50; margin: -10px -10px 15px -10px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #76ff03; font-weight: bold; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; border: 3px solid #4caf50; }
        .game-title { font-size: clamp(1.8rem, 5vw, 3rem); color: #76ff03; text-align: center; margin-bottom: 10px; }
        .exp-container { width: 100%; background: #1b3012; height: 15px; border-radius: 10px; margin: 5px 0; border: 1px solid #4caf50; overflow: hidden; }
        .exp-bar { height: 100%; background: #76ff03; width: 0%; transition: width 0.3s; }
        .game-area { display: flex; flex-wrap: wrap; gap: 15px; }
        .main-garden { flex: 2; min-width: 300px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        .click-area { width: 220px; height: 220px; margin: 20px auto; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 100px; user-select: none; transition: transform 0.1s; background: radial-gradient(circle, rgba(118,255,3,0.2) 0%, transparent 70%); }
        .click-area:active { transform: scale(0.9); }
        .coins-display { font-size: 2em; color: #fff; margin: 10px 0; }
        #chat-box { height: 200px; background: rgba(0,0,0,0.5); border: 1px solid #4caf50; border-radius: 8px; margin: 10px 0; padding: 10px; overflow-y: auto; font-size: 0.85em; }
        .upgrade-item { background: rgba(255,255,255,0.05); padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #4caf50; }
        button { background: #4caf50; color: #fff; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 5px; }
        button:disabled { background: #333; color: #777; }
    </style>
</head>
<body>

    <div id="msgNotification" onclick="scrollToChat()">
        ðŸ’¬ <span id="unreadCount">0</span> UNREAD
    </div>

    <div class="top-status-bar">
        <div>ðŸ“… <span id="liveDate"></span></div>
        <div>ðŸ•’ <span id="liveClock"></span></div>
        <div>ðŸ‘¥ <span id="onlineCount">1</span> Online</div>
    </div>

    <div class="container">
        <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
        <div style="text-align:center; margin-bottom:20px;">
            Grower: <b id="playerNameDisplay" style="color:#76ff03">...</b> | 
            Level: <b id="levelDisplay">1</b>
            <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
        </div>

        <div class="game-area">
            <div class="main-garden">
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <div id="hpsDisplay" style="color:#aed581">0 g/sec</div>
                <button onclick="buyPrestige()" id="prestigeBtn">Buy Prestige</button>
            </div>

            <div class="stats-sidebar">
                <h3>Global Chat</h3>
                <div id="chat-box"></div>
                <input type="text" id="chatInput" placeholder="Type message..." style="width:100%; padding:8px; border-radius:5px; border:none; background:#111; color:#fff;">
                <button onclick="testNotify()" style="background:#222; font-size:0.7em; margin-top:10px;">Test Notification</button>
                <h3 style="margin-top:20px;">Leaderboard</h3>
                <div id="leaderboard" style="font-size:0.8em"></div>
            </div>

            <div class="upgrades-shop">
                <h3>Shop</h3>
                <div id="shopItems"></div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let state = {
            name: localStorage.getItem('cannaUsername') || "Grower" + Math.floor(Math.random()*999),
            grams: 0, level: 1, exp: 0, prestige: 1, donations: 0,
            crew: { trimmers: { n: 0, c: 20, p: 1 }, growers: { n: 0, c: 150, p: 5 } },
            strains: { skunk: { n: 0, c: 1000, p: 25 }, haze: { n: 0, c: 5000, p: 150 } }
        };

        let unread = 0;

        function testNotify() {
            unread++;
            document.getElementById('unreadCount').innerText = unread;
            document.getElementById('msgNotification').style.display = 'block';
        }

        function scrollToChat() {
            const cb = document.getElementById('chat-box');
            cb.scrollTop = cb.scrollHeight;
            unread = 0;
            document.getElementById('msgNotification').style.display = 'none';
        }

        async function init() {
            document.getElementById('playerNameDisplay').innerText = state.name;
            
            // Listen for Chat
            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                const cb = document.getElementById('chat-box');
                cb.innerHTML += `<div><b>${p.new.player_name}:</b> ${p.new.message_text}</div>`;
                
                // If message isn't from us, show notification
                if (p.new.player_name !== state.name) {
                    unread++;
                    document.getElementById('unreadCount').innerText = unread;
                    document.getElementById('msgNotification').style.display = 'block';
                }
                
                // If we are already at the bottom, auto-scroll and clear
                if (cb.scrollHeight - cb.scrollTop <= cb.clientHeight + 50) {
                    cb.scrollTop = cb.scrollHeight;
                    unread = 0;
                    document.getElementById('msgNotification').style.display = 'none';
                }
            }).subscribe();

            document.getElementById('chatInput').onkeypress = async e => {
                if(e.key === 'Enter' && e.target.value.trim()){
                    const m = e.target.value; e.target.value = '';
                    await sb.from('messages').insert([{player_name: state.name, message_text: m}]);
                }
            };

            // Game Loop
            setInterval(() => {
                let hps = (state.crew.trimmers.n * 1 + state.crew.growers.n * 5 + state.strains.skunk.n * 25) * state.prestige;
                state.grams += hps/10;
                document.getElementById('coinsDisplay').innerText = Math.floor(state.grams) + " Grams";
                document.getElementById('hpsDisplay').innerText = hps + " g/sec";
                
                document.getElementById('liveClock').innerText = new Date().toLocaleTimeString();
                document.getElementById('liveDate').innerText = new Date().toLocaleDateString();
            }, 100);
        }

        document.getElementById('clickArea').onclick = () => {
            state.grams += state.prestige;
            document.getElementById('coinsDisplay').innerText = Math.floor(state.grams) + " Grams";
        };

        window.onload = init;
    </script>
</body>
</html>
