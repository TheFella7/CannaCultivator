<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Canna Cultivator - Cloud Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #121d0a; color: #e0e0e0; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        .game-card { background: #1a2a12; border: 2px solid #4caf50; border-radius: 15px; padding: 25px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .stat-box { font-size: 2em; color: #76ff03; text-align: center; margin: 15px 0; }
        .shop-item { background: #000; padding: 12px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #4caf50; }
        button { width: 100%; padding: 10px; background: #4caf50; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button:disabled { background: #333; opacity: 0.5; cursor: not-allowed; }
        .purchased { color: #76ff03; font-weight: bold; font-style: italic; }
        #chat { height: 100px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 5px; font-size: 0.8em; margin-top: 10px; border: 1px solid #333; }
        #save-status { font-size: 0.7em; text-align: right; color: #4caf50; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="game-card">
        <h2 style="text-align:center; color:#76ff03">ðŸŒ¿ Canna Cultivator</h2>
        <p style="text-align:center">Grower: <span id="pName">...</span></p>
        
        <div class="stat-box" id="gramCount">0g</div>
        <button id="clickBtn" style="height:60px; font-size:1.5em">HARVEST ðŸŒ¿</button>
        <p style="text-align:center; margin-top:5px" id="hpsRate">0 g/sec</p>

        <h3 style="margin-top:20px">The Crew (Buy Max)</h3>
        <div id="crewArea"></div>

        <h3 style="margin-top:20px">Strains (Single Purchase)</h3>
        <div id="strainArea"></div>

        <h3>Global Chat</h3>
        <div id="chat"></div>
        <input type="text" id="msgInput" placeholder="Chat here..." style="width:100%; padding:8px; background:#000; color:#fff; border:1px solid #4caf50">
        
        <div id="save-status">Cloud Synced</div>
    </div>

    <script>
        const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let game = {
            name: "", grams: 0,
            crew: { trimmer: { n: 0, c: 20, p: 1 }, grower: { n: 0, c: 150, p: 5 } },
            strains: [] 
        };

        const staticStrains = [
            { id: 'skunk', name: 'Skunk #1', cost: 1000, x: 2 },
            { id: 'haze', name: 'Purple Haze', cost: 5000, x: 5 }
        ];

        function getMult() {
            let m = 1;
            staticStrains.forEach(s => { if(game.strains.includes(s.id)) m *= s.x; });
            return m;
        }

        function updateUI() {
            const m = getMult();
            const hps = (game.crew.trimmer.n * game.crew.trimmer.p + game.crew.grower.n * game.crew.grower.p) * m;
            document.getElementById('gramCount').innerText = Math.floor(game.grams).toLocaleString() + "g";
            document.getElementById('hpsRate').innerText = hps.toLocaleString() + " g/sec (x" + m + ")";

            // Crew UI
            document.getElementById('crewArea').innerHTML = Object.keys(game.crew).map(id => `
                <div class="shop-item">
                    <b>${id.toUpperCase()}</b> (${game.crew[id].n})<br>
                    <button onclick="buyMax('${id}')" ${game.grams < game.crew[id].c ? 'disabled' : ''}>Buy Max: ${game.crew[id].c}g</button>
                </div>
            `).join('');

            // Strains UI
            document.getElementById('strainArea').innerHTML = staticStrains.map(s => {
                const owned = game.strains.includes(s.id);
                return `
                    <div class="shop-item">
                        <b>${s.name} (x${s.x} Boost)</b><br>
                        ${owned ? '<span class="purchased">OWNED</span>' : `<button onclick="buyStrain('${s.id}')" ${game.grams < s.cost ? 'disabled' : ''}>Buy: ${s.cost}g</button>`}
                    </div>
                `;
            }).join('');
        }

        function buyMax(id) {
            while(game.grams >= game.crew[id].c) {
                game.grams -= game.crew[id].c;
                game.crew[id].n++;
                game.crew[id].c = Math.floor(game.crew[id].c * 1.25);
            }
            updateUI();
        }

        function buyStrain(id) {
            const s = staticStrains.find(x => x.id === id);
            if(!game.strains.includes(id) && game.grams >= s.cost) {
                game.grams -= s.cost;
                game.strains.push(id);
                updateUI();
            }
        }

        async function init() {
            game.name = prompt("Grower Name?") || "User" + Math.floor(Math.random()*99);
            document.getElementById('pName').innerText = game.name;

            const { data } = await sb.from('leaderboard').select('game_state').eq('player_name', game.name).single();
            if(data) game = data.game_state;

            // Chat
            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                const c = document.getElementById('chat');
                c.innerHTML += `<div><b>${p.new.player_name}:</b> ${p.new.message_text}</div>`;
                c.scrollTop = c.scrollHeight;
            }).subscribe();

            // Loop
            setInterval(() => {
                const hps = (game.crew.trimmer.n * 1 + game.crew.grower.n * 5) * getMult();
                game.grams += hps / 10;
                updateUI();
            }, 100);

            // 1s Auto-Save
            setInterval(async () => {
                await sb.from('leaderboard').upsert({ player_name: game.name, grams: Math.floor(game.grams), game_state: game, last_active: new Date() });
            }, 1000);

            document.getElementById('clickBtn').onclick = () => { game.grams += 1 * getMult(); updateUI(); };
            document.getElementById('msgInput').onkeypress = async e => {
                if(e.key === 'Enter' && e.target.value.trim()){
                    await sb.from('messages').insert([{player_name:game.name, message_text:e.target.value}]);
                    e.target.value = '';
                }
            };
        }
        window.onload = init;
    </script>
</body>
</html>
