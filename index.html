<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator - Secure Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AZawPulf_LA1GNqlqUE_L6PC4UqJsan33_c5L9wEcOLTRK1itpzK1QrSwueuFyPlbaEV7U0JejX_Vd70&currency=GBP"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 0 10px 10px 10px; }
        
        /* TOP STATUS BAR - REVERTED TO TOP POSITION */
        .top-status-bar {
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid #4caf50;
            margin: 0 -10px 15px -10px;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #76ff03;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            font-weight: bold;
        }
        .status-item { display: flex; align-items: center; gap: 5px; }

        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 3px solid #4caf50; }
        .header { text-align: center; padding: 5px; border-bottom: 3px solid #4caf50; margin-bottom: 20px; }
        .game-title { font-size: clamp(1.8rem, 5vw, 3rem); color: #76ff03; text-shadow: 2px 2px 0 #1b3012; margin-bottom: 5px; }
        
        .exp-container { width: 100%; background: #1b3012; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #4caf50; }
        .exp-bar { height: 100%; background: linear-gradient(90deg, #76ff03, #4caf50); width: 0%; transition: width 0.3s; }
        
        .game-area { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-garden { flex: 2; min-width: 280px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        
        .section-title { color: #76ff03; font-size: 1.5em; margin-bottom: 15px; border-bottom: 1px solid #4caf50; padding-bottom: 5px; }
        .click-area { width: clamp(200px, 40vw, 280px); height: clamp(200px, 40vw, 280px); margin: 20px auto; background: radial-gradient(circle, rgba(118, 255, 3, 0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.05s; position: relative; font-size: 120px; user-select: none; }
        .click-area:active { transform: scale(0.92); }
        
        .coins-display { font-size: 2.2em; color: #fff; margin: 10px 0; text-shadow: 2px 2px 0 #000; }
        .herb-count { color: #aed581; font-weight: bold; margin: 5px 0; }
        .tap-stat { color: #76ff03; font-weight: bold; font-size: 1.1em; }
        
        .upgrade-item { background: rgba(60, 90, 40, 0.4); padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #4caf50; }
        .prestige-box { background: rgba(118, 255, 3, 0.1); border: 2px dashed #76ff03; padding: 15px; margin-top: 15px; border-radius: 10px; text-align: center; }
        
        button { background: linear-gradient(to bottom, #4caf50, #2e7d32); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #444; }
        
        .paypal-box { margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.5); border: 2px solid #ffc107; border-radius: 12px; }
        #chat-box { height: 150px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-top: 10px; padding: 5px; overflow-y: auto; font-size: 0.8em; border: 1px solid #388e3c; }
        
        .leaderboard-item { display: flex; flex-direction: column; padding: 8px; border-bottom: 1px solid #388e3c; }
        .you-row { border: 1px solid #76ff03; background: rgba(118,255,3,0.1); }
        .lb-stats { display: flex; justify-content: space-between; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="top-status-bar">
        <div class="status-item">ðŸ“… <span id="liveDate">03/01/2026</span></div>
        <div class="status-item">ðŸ•’ <span id="liveClock">00:00:00</span></div>
        <div class="status-item">ðŸ‘¥ <span id="onlineCount">1</span> Online</div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
            <p>Welcome, <span id="playerNameDisplay" style="color:#76ff03">...</span>!</p>
            <div style="margin-top: 10px;">
                <span>Level: <b id="levelDisplay">1</b></span>
                <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
                <small id="expText">0 / 5,000 EXP</small>
            </div>
        </div>

        <div class="game-area">
            <div class="main-garden">
                <h2 class="section-title">Cultivation</h2>
                <div class="tap-stat">Tap Value: +<span id="tapEarned">1</span>g</div>
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <p class="herb-count" id="hpsDisplay">0 g/sec</p>
                
                <div class="prestige-box">
                    <div style="color:#76ff03; font-weight: bold;">Multiplier: x<span id="prestigeMult">1</span></div>
                    <button id="prestigeBtn" onclick="buyPrestige()">Buy Prestige</button>
                    
                    <div class="paypal-box">
                        <p style="color:#fff; font-weight: bold;">x20 PERMANENT BOOST</p>
                        <p style="color:#ffc107; font-weight: bold; margin: 5px 0;">Â£4.99</p>
                        <p style="color:#ffc107; font-size: 0.8em; margin-bottom: 10px;">Stacks: <span id="stackCount">0</span></p>
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>

            <div class="stats-sidebar">
                <h2 class="section-title">Leaderboard</h2>
                <div id="leaderboard">Loading...</div>

                <h2 class="section-title" style="margin-top:20px;">Global Chat</h2>
                <div id="chat-box"></div>
                <input type="text" id="chatInput" placeholder="Press Enter to chat..." style="width:100%; background:#1b3012; border:1px solid #4caf50; color:#fff; padding:5px; margin-top:5px; border-radius:5px;">

                <h2 class="section-title" style="margin-top:20px;">The Crew</h2>
                <div id="crewButtons"></div>
            </div>

            <div class="upgrades-shop">
                <h2 class="section-title">Strains</h2>
                <div id="strainList"></div>

                <h2 class="section-title" style="margin-top:20px;">Supplies</h2>
                <div id="shopList"></div>
                
                <button onclick="hardReset()" style="background: #7d2e2e; margin-top: 20px; font-size: 0.8em;">RESET GAME</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let state = {
            name: "", grams: 0, level: 1, exp: 0, prestige: 1, donations: 0,
            crew: { trimmers: { n: 0, c: 20, p: 1 }, growers: { n: 0, c: 150, p: 5 } },
            upgrades: [], strains: [] 
        };

        // Anti-Cheat Variables
        let lastClickTime = 0;
        const MIN_DELAY = 60; // Caps manual clicking

        const staticData = {
            upgrades: [
                { id: 'shears', name: 'Sharp Shears', cost: 100, x: 2, type: 'tap' },
                { id: 'lights', name: 'LED Lights', cost: 500, x: 1.5, type: 'auto' },
                { id: 'hydro', name: 'Hydroponics', cost: 2000, x: 3, type: 'auto' }
            ],
            strains: [
                { id: 'skunk', name: 'Skunk #1', cost: 1000, x: 2 },
                { id: 'haze', name: 'Purple Haze', cost: 5000, x: 5 },
                { id: 'kush', name: 'OG Kush', cost: 25000, x: 10 }
            ]
        };

        function formatNum(n) {
            if (n === 0) return "0"; 
            if (n < 1000) return Math.floor(n).toString();
            const suffixes = ["", "k", "m", "b", "t", "a", "b", "c", "d"];
            const suffixNum = Math.floor(("" + Math.floor(n)).length / 3);
            let shortValue = parseFloat((suffixNum != 0 ? (n / Math.pow(1000, suffixNum)) : n).toPrecision(3));
            if (shortValue % 1 != 0) shortValue = shortValue.toFixed(1);
            return shortValue + suffixes[suffixNum];
        }

        function getMults() {
            let tap = 1, auto = 1, sMult = 1;
            state.strains.forEach(id => { const s = staticData.strains.find(x => x.id === id); if(s) sMult *= s.x; });
            state.upgrades.forEach(id => { 
                const u = staticData.upgrades.find(x => x.id === id);
                if(u) { if(u.type === 'tap') tap *= u.x; else auto *= u.x; }
            });
            const global = state.prestige * (1 + (state.level * 0.1)) * Math.pow(20, state.donations) * sMult;
            return { tap: tap * global, auto: auto * global };
        }

        function getExpRequired(lvl) {
            return Math.floor(Math.pow(lvl, 3.5)) * 5000;
        }

        function updateUI() {
            const m = getMults();
            const hps = (state.crew.trimmers.n * 1 + state.crew.growers.n * 5) * m.auto;
            document.getElementById('coinsDisplay').innerText = formatNum(state.grams) + " Grams";
            document.getElementById('hpsDisplay').innerText = formatNum(hps) + " g/sec";
            document.getElementById('tapEarned').innerText = formatNum(m.tap);
            document.getElementById('prestigeMult').innerText = formatNum(state.prestige);
            document.getElementById('stackCount').innerText = state.donations;

            const nextCost = 100000 * Math.pow(state.prestige, 3);
            let pMax = 0, totalP = 0, tempP = state.prestige;
            while(state.grams >= totalP + (100000 * Math.pow(tempP, 3))) { totalP += (100000 * Math.pow(tempP, 3)); tempP++; pMax++; if(pMax > 100) break;}
            document.getElementById('prestigeBtn').innerText = pMax > 0 ? `Prestige (+${pMax})` : `Next: ${formatNum(nextCost)}g`;
            document.getElementById('prestigeBtn').disabled = pMax === 0;

            const req = getExpRequired(state.level);
            document.getElementById('levelDisplay').innerText = state.level;
            document.getElementById('expBar').style.width = `${Math.min((state.exp / req) * 100, 100)}%`;
            document.getElementById('expText').innerText = `${formatNum(state.exp)} / ${formatNum(req)} EXP`;

            document.getElementById('crewButtons').innerHTML = Object.keys(state.crew).map(id => {
                let count = 0, total = 0, next = state.crew[id].c;
                while (state.grams >= total + next) { total += next; next = Math.floor(next * 1.35); count++; if(count > 50) break; }
                return `<div class="upgrade-item"><b>${id.toUpperCase()}</b> (${state.crew[id].n})<button onclick="buyMaxCrew('${id}')" ${count === 0 ? 'disabled' : ''}>${count > 0 ? `Buy Max (+${count})` : `Next: ${formatNum(state.crew[id].c)}`}</button></div>`;
            }).join('');

            document.getElementById('strainList').innerHTML = staticData.strains.map(s => `
                <div class="upgrade-item"><b>${s.name}</b><br>${state.strains.includes(s.id) ? '<span style="color:#76ff03">OWNED</span>' : `<button onclick="buyStrain('${s.id}')" ${state.grams < s.cost ? 'disabled' : ''}>${formatNum(s.cost)}g</button>`}</div>
            `).join('');

            document.getElementById('shopList').innerHTML = staticData.upgrades.map(u => `
                <div class="upgrade-item"><b>${u.name}</b><br>${state.upgrades.includes(u.id) ? '<span style="color:#76ff03">OWNED</span>' : `<button onclick="buyUpgrade('${u.id}')" ${state.grams < u.cost ? 'disabled' : ''}>${formatNum(u.cost)}g</button>`}</div>
            `).join('');
        }

        function buyPrestige() {
            let pMax = 0, totalP = 0, tempP = state.prestige;
            while(state.grams >= totalP + (100000 * Math.pow(tempP, 3))) { totalP += (100000 * Math.pow(tempP, 3)); tempP++; pMax++; }
            if (pMax > 0) {
                state.prestige += pMax; state.grams = 0; state.upgrades = [];
                state.crew.trimmers = { n: 0, c: 20, p: 1 };
                state.crew.growers = { n: 0, c: 150, p: 5 };
                updateUI();
            }
        }

        function buyMaxCrew(id) {
            let total = 0, next = state.crew[id].c, count = 0;
            while (state.grams >= total + next) { total += next; next = Math.floor(next * 1.35); count++; }
            if(count > 0) { state.grams -= total; state.crew[id].n += count; state.crew[id].c = next; updateUI(); }
        }

        function buyStrain(id) {
            const s = staticData.strains.find(x => x.id === id);
            if(!state.strains.includes(id) && state.grams >= s.cost) { state.grams -= s.cost; state.strains.push(id); updateUI(); }
        }

        function buyUpgrade(id) {
            const u = staticData.upgrades.find(x => x.id === id);
            if(!state.upgrades.includes(id) && state.grams >= u.cost) { state.grams -= u.cost; state.upgrades.push(id); updateUI(); }
        }

        function hardReset() {
            if(confirm("Full Reset? (Grams, Levels, and Crew will be wiped. PayPal stays!)")) {
                state.grams = 0; state.level = 1; state.exp = 0; state.prestige = 1;
                state.crew = { trimmers: { n: 0, c: 20, p: 1 }, growers: { n: 0, c: 150, p: 5 } };
                state.upgrades = []; state.strains = []; updateUI();
            }
        }

        async function init() {
            let savedName = localStorage.getItem('cannaUsername');
            if(!savedName) {
                savedName = (prompt("Grower Name:") || "Grower" + Math.floor(Math.random()*99)).replace(/<[^>]*>/g, "").substring(0, 15);
                localStorage.setItem('cannaUsername', savedName);
            }
            state.name = savedName;
            document.getElementById('playerNameDisplay').innerText = state.name;

            const { data } = await sb.from('leaderboard').select('game_state').eq('player_name', state.name).single();
            if(data) state = {...state, ...data.game_state};

            paypal.Buttons({
                createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '4.99' } }] }),
                onApprove: (d, a) => a.order.capture().then(() => { state.donations++; updateUI(); })
            }).render('#paypal-button-container');

            setInterval(() => {
                const m = getMults();
                const hps = (state.crew.trimmers.n * 1 + state.crew.growers.n * 5) * m.auto;
                state.grams += hps / 10;
                state.exp += (hps / 10) * state.prestige;
                const req = getExpRequired(state.level);
                if(state.exp >= req) { state.exp -= req; state.level++; }
                updateUI();
            }, 100);

            setInterval(() => {
                const now = new Date();
                document.getElementById('liveClock').innerText = now.toLocaleTimeString();
                document.getElementById('liveDate').innerText = now.toLocaleDateString();
            }, 1000);

            setInterval(async () => {
                await sb.from('leaderboard').upsert({ 
                    player_name: state.name, grams: Math.floor(state.grams), game_state: state, player_level: state.level, last_active: new Date().toISOString()
                }, { onConflict: 'player_name' });
                const fiveMinsAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                const { count } = await sb.from('leaderboard').select('*', { count: 'exact', head: true }).gt('last_active', fiveMinsAgo);
                document.getElementById('onlineCount').innerText = count || 1;
            }, 5000);

            setInterval(async () => {
                const { data } = await sb.from('leaderboard').select('player_name, player_level, grams').order('grams', {ascending:false}).limit(10);
                if(data) document.getElementById('leaderboard').innerHTML = data.map((p,i)=>`
                    <div class="leaderboard-item ${p.player_name === state.name ? 'you-row' : ''}">
                        <b>#${i+1} ${p.player_name.replace(/<[^>]*>/g, "")}</b>
                        <div class="lb-stats"><span>Lvl ${p.player_level}</span><span>${formatNum(p.grams)}g</span></div>
                    </div>`).join('');
            }, 10000);

            document.getElementById('clickArea').onclick = () => { 
                const now = Date.now();
                if(now - lastClickTime < MIN_DELAY) return; // Anti-cheat click cap
                lastClickTime = now;
                state.grams += getMults().tap; 
                state.exp += (25 * state.prestige);
                updateUI(); 
            };
            
            document.getElementById('chatInput').onkeypress = async e => {
                if(e.key === 'Enter' && e.target.value.trim()){
                    const clean = e.target.value.replace(/<[^>]*>/g, "").substring(0, 80);
                    await sb.from('messages').insert([{player_name:state.name, message_text:clean}]);
                    e.target.value = '';
                }
            };

            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                const box = document.getElementById('chat-box');
                box.innerHTML += `<div><b>${p.new.player_name.replace(/<[^>]*>/g, "")}:</b> ${p.new.message_text.replace(/<[^>]*>/g, "")}</div>`;
                box.scrollTop = box.scrollHeight;
            }).subscribe();
        }

        window.onload = init;
    </script>
</body>
</html>

