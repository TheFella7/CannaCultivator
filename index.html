<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canna Cultivator</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AZawPulf_LA1GNqlqUE_L6PC4UqJsan33_c5L9wEcOLTRK1itpzK1QrSwueuFyPlbaEV7U0JejX_Vd70&currency=GBP"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #050a02;
            color: #76ff03;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        #game-container {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .header-box {
            border: 2px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(118, 255, 3, 0.05);
        }

        h1 { font-size: 2.5rem; text-shadow: 2px 2px #000; margin: 0; }

        .plant-button {
            font-size: 100px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
            margin: 30px 0;
            display: inline-block;
        }

        .plant-button:active { transform: scale(0.9); }

        .stat-line {
            font-size: 1.5rem;
            color: #fff;
            margin: 10px 0;
        }

        .menu-section {
            width: 100%;
            margin-top: 20px;
            border-top: 1px solid #4caf50;
            padding-top: 20px;
        }

        .item-card {
            background: #111;
            border: 1px solid #4caf50;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            background: #4caf50;
            color: #000;
            border: none;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover { background: #76ff03; }
        button:disabled { background: #222; color: #444; }

        #leaderboard-box, #chat-box {
            width: 100%;
            background: #000;
            border: 1px solid #4caf50;
            height: 150px;
            overflow-y: auto;
            text-align: left;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .floating-num {
            position: fixed;
            color: #fff;
            font-weight: bold;
            pointer-events: none;
            animation: flyUp 1s forwards;
        }

        @keyframes flyUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="header-box">
        <h1>CANNA CULTIVATOR</h1>
        <p>GROWER: <span id="display-name">...</span></p>
    </div>

    <div class="stat-line"><span id="grams-total">0</span> GRAMS</div>
    <div id="gps-display" style="color: #4caf50;">0.0 g/sec</div>

    <div class="plant-button" id="main-plant">ðŸŒ¿</div>

    <div class="menu-section">
        <h3>EQUIPMENT</h3>
        <div id="equipment-list"></div>
    </div>

    <div class="menu-section">
        <h3>LIVE LEADERBOARD</h3>
        <div id="leaderboard-box"></div>
    </div>

    <div class="menu-section">
        <h3>GLOBAL CHAT</h3>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Say something..." style="width: 100%; background: #000; border: 1px solid #4caf50; color: #76ff03; padding: 10px; margin-top: 5px;">
    </div>

    <div class="menu-section">
        <p style="font-size: 0.8rem; margin-bottom: 10px;">SUPPORT THE GROW (x20 BOOST)</p>
        <div id="paypal-container"></div>
    </div>
</div>

<script>
    const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
    const SB_KEY = 'EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    let game = {
        name: "",
        grams: 0,
        donations: 0,
        items: { trimmer: 0, grower: 0 },
        costs: { trimmer: 15, grower: 100 }
    };

    function init() {
        const saved = localStorage.getItem('canna_original_v1');
        if(saved) game = Object.assign(game, JSON.parse(saved));
        if(!game.name) game.name = prompt("Enter Grower Name:") || "Unknown";
        document.getElementById('display-name').innerText = game.name;

        updateStore();
        tick();
        setupPaypal();
        loadLeaderboard();
        setupChat();
        setInterval(sync, 10000);
    }

    async function sync() {
        await supabase.from('players').upsert({ player_name: game.name, total_grams: Math.floor(game.grams) }, { onConflict: 'player_name' });
        loadLeaderboard();
    }

    async function loadLeaderboard() {
        const { data } = await supabase.from('players').select('*').order('total_grams', { ascending: false }).limit(5);
        if(data) {
            document.getElementById('leaderboard-box').innerHTML = data.map(p => `<div>${p.player_name}: ${Math.floor(p.total_grams)}g</div>`).join('');
        }
    }

    function setupChat() {
        supabase.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'global_chat' }, payload => {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div>[${payload.new.player_name}]: ${payload.new.message_text}</div>`;
            box.scrollTop = box.scrollHeight;
        }).subscribe();

        document.getElementById('chat-input').onkeydown = async (e) => {
            if(e.key === 'Enter' && e.target.value) {
                await supabase.from('global_chat').insert([{ player_name: game.name, message_text: e.target.value }]);
                e.target.value = '';
            }
        };
    }

    function setupPaypal() {
        paypal.Buttons({
            createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '4.99' } }] }),
            onApprove: (d, a) => a.order.capture().then(() => { game.donations++; })
        }).render('#paypal-container');
    }

    document.getElementById('main-plant').onclick = (e) => {
        const power = 1 + (game.donations * 20);
        game.grams += power;
        
        const f = document.createElement('div');
        f.className = 'floating-num';
        f.innerText = "+" + power;
        f.style.left = e.clientX + "px";
        f.style.top = e.clientY + "px";
        document.body.appendChild(f);
        setTimeout(() => f.remove(), 1000);
    };

    function updateStore() {
        document.getElementById('equipment-list').innerHTML = `
            <div class="item-card">
                <span>Trimmer (1g/s) [${game.items.trimmer}]</span>
                <button onclick="buy('trimmer')">BUY ${game.costs.trimmer}g</button>
            </div>
            <div class="item-card">
                <span>Master Grower (10g/s) [${game.items.grower}]</span>
                <button onclick="buy('grower')">BUY ${game.costs.grower}g</button>
            </div>
        `;
    }

    window.buy = (id) => {
        if(game.grams >= game.costs[id]) {
            game.grams -= game.costs[id];
            game.items[id]++;
            game.costs[id] = Math.floor(game.costs[id] * 1.5);
            updateStore();
        }
    };

    function tick() {
        const auto = (game.items.trimmer * 1) + (game.items.grower * 10);
        const boost = 1 + (game.donations * 20);
        game.grams += (auto * boost) / 10;
        
        document.getElementById('grams-total').innerText = Math.floor(game.grams).toLocaleString();
        document.getElementById('gps-display').innerText = (auto * boost).toFixed(1) + " g/sec";
        
        localStorage.setItem('canna_original_v1', JSON.stringify(game));
        setTimeout(tick, 100);
    }

    window.onload = init;
</script>
</body>
</html>

