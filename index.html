<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator - Live</title>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=GBP"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 3px solid #4caf50; }
        .header { text-align: center; padding: 10px; border-bottom: 3px solid #4caf50; margin-bottom: 20px; }
        .game-title { font-size: clamp(1.8rem, 5vw, 3rem); color: #76ff03; text-shadow: 2px 2px 0 #1b3012; margin-bottom: 5px; }
        .exp-container { width: 100%; background: #1b3012; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #4caf50; }
        .exp-bar { height: 100%; background: linear-gradient(90deg, #76ff03, #4caf50); width: 0%; transition: width 0.3s; }
        .game-area { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-garden { flex: 2; min-width: 280px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        .section-title { color: #76ff03; font-size: 1.5em; margin-bottom: 15px; border-bottom: 1px solid #4caf50; padding-bottom: 5px; }
        .click-area { width: clamp(200px, 40vw, 280px); height: clamp(200px, 40vw, 280px); margin: 20px auto; background: radial-gradient(circle, rgba(118, 255, 3, 0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.05s; position: relative; font-size: 120px; user-select: none; }
        .click-area:active { transform: scale(0.92); }
        .coins-display { font-size: 2.2em; color: #fff; margin: 10px 0; text-shadow: 2px 2px 0 #000; }
        .herb-count { color: #aed581; font-weight: bold; margin: 5px 0; }
        .leaderboard-list { list-style: none; font-size: 0.9em; max-height: 200px; overflow-y: auto; }
        .leaderboard-item { display: flex; flex-direction: column; padding: 8px; border-bottom: 1px solid #388e3c; }
        .you-row { color: #76ff03; font-weight: bold; background: rgba(118, 255, 3, 0.1); }
        .lb-stats { display: flex; justify-content: space-between; font-size: 0.85em; opacity: 0.9; }
        .upgrade-item { background: rgba(60, 90, 40, 0.4); padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #4caf50; }
        .bonus-info { display: block; font-size: 0.85em; color: #76ff03; margin-bottom: 5px; }
        .prestige-box { background: rgba(118, 255, 3, 0.1); border: 2px dashed #76ff03; padding: 15px; margin-top: 15px; border-radius: 10px; text-align: center; }
        .paypal-container { margin-top: 15px; padding: 12px; background: rgba(0, 0, 0, 0.4); border-radius: 12px; border: 2px solid #ffc107; }
        .price-badge { display: inline-block; background: #ffc107; color: #000; padding: 2px 8px; border-radius: 5px; font-weight: bold; font-size: 1.1em; margin: 5px 0; }
        button { background: linear-gradient(to bottom, #4caf50, #2e7d32); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; transition: 0.2s; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: linear-gradient(to bottom, #666, #444); }
        .floating-num { position: fixed; color: #76ff03; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 1000; text-shadow: 1px 1px 2px black; font-size: 1.5rem; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120px); opacity: 0; } }
        .helper { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; margin: 5px 0; border-radius: 5px; }
        #chat-box { height: 150px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-top: 10px; padding: 5px; overflow-y: auto; font-size: 0.8em; border: 1px solid #388e3c; }
        .active-strain { background: rgba(118, 255, 3, 0.2) !important; border-color: #76ff03 !important; }
        .chat-message { margin: 3px 0; padding: 3px; border-radius: 3px; }
        .chat-message.system { color: #76ff03; font-style: italic; }
        .chat-message.user { color: #aed581; }
        .chat-message.other { color: #f0f7da; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
            <p>Welcome, <span id="playerNameDisplay" style="color:#76ff03">Grower</span>!</p>
            <div style="margin-top: 10px;">
                <span>Player Level: <b id="levelDisplay">1</b></span>
                <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
                <small id="expText">0 / 1,000 EXP</small>
            </div>
        </div>
        
        <div class="game-area">
            <div class="main-garden">
                <h2 class="section-title">Cultivation</h2>
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <p class="herb-count" id="hpcDisplay">1g/click</p>
                <p class="herb-count" id="hpsDisplay">0g/sec</p>

                <div class="prestige-box" id="prestigeBox">
                    <div style="color:#76ff03; font-weight: bold;">Mastery Multiplier: x<span id="prestigeMult">1</span></div>
                    <button id="prestigeBtn" onclick="prestigeMax()">Buy Max Prestige</button>
                    
                    <div class="paypal-container">
                        <p style="color:#fff; font-weight: bold;">PERMANENT x20 BOOST (STACKABLE)</p>
                        <div class="price-badge">ONLY Â£4.99</div>
                        <p style="color:#aed581; font-size: 0.8em; margin-bottom: 10px;">Current Stacks: <span id="stackCount">0</span></p>
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>
            
            <div class="stats-sidebar">
                <h2 class="section-title">Leaderboard</h2>
                <div id="leaderboard" class="leaderboard-list"></div>
                
                <h2 class="section-title" style="margin-top:20px;">Global Chat</h2>
                <div id="chat-box">
                    <div class="chat-message system">System: Welcome to the grow room!</div>
                </div>
                <input type="text" id="chatInput" placeholder="Press Enter to chat..." style="width:100%; background:#1b3012; border:1px solid #4caf50; color:#fff; padding:5px; margin-top:5px; border-radius:5px;">

                <h2 class="section-title" style="margin-top:20px;">The Crew</h2>
                <div class="helper"><span>Trimmers:</span><b id="count-trimmers">0</b></div>
                <div class="helper"><span>Growers:</span><b id="count-growers">0</b></div>
                <div id="crewButtons"></div>
            </div>
            
            <div class="upgrades-shop">
                <h2 class="section-title">New Strains</h2>
                <div id="strainList"></div>
                <h2 class="section-title" style="margin-top:20px;">Supplies</h2>
                <div id="shopList"></div>
                <button onclick="resetGame()" style="background: #7d2e2e; margin-top: 20px; font-size: 0.8em;">Wipe Save</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Player ID for tracking
        let playerId = localStorage.getItem('playerId');
        if (!playerId) {
            playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('playerId', playerId);
        }
        
        // Real-time subscriptions
        let leaderboardSubscription = null;
        let chatSubscription = null;
        let purchasesSubscription = null;
        
        function formatNum(num) {
            if (num < 1000) return Math.floor(num).toLocaleString();
            const suffixes = ["", "k", "m", "b", "t"];
            const exp = Math.floor(Math.log10(num) / 3);
            return (num / Math.pow(10, exp * 3)).toFixed(2) + suffixes[exp];
        }

        let gameState = {
            playerName: "", grams: 0, totalHarvested: 0, prestigeLevel: 1, level: 1, exp: 0, donations: 0,
            multipliers: { tap: 1, auto: 1, strain: 1 },
            crew: { trimmers: { count: 0, cost: 20, power: 1 }, growers: { count: 0, cost: 150, power: 5 } },
            upgrades: [], strainsOwned: ['ditch'],
            currentStrain: 'ditch'
        };

        const upgrades = [
            { id: 'shears', name: 'Sharp Shears', cost: 100, bonus: 2, type: 'tap', desc: 'x2 Tap Yield' },
            { id: 'lights', name: 'LED Lights', cost: 500, bonus: 1.5, type: 'auto', desc: 'x1.5 Auto Yield' },
            { id: 'hydro', name: 'Hydroponics', cost: 2000, bonus: 3, type: 'auto', desc: 'x3 Auto Yield' }
        ];

        const strains = [
            { id: 'skunk', name: 'Skunk #1', cost: 1000, mult: 2, desc: 'x2 Global Yield' },
            { id: 'haze', name: 'Purple Haze', cost: 5000, mult: 5, desc: 'x5 Global Yield' },
            { id: 'kush', name: 'OG Kush', cost: 25000, mult: 10, desc: 'x10 Global Yield' },
            { id: 'widow', name: 'White Widow', cost: 100000, mult: 50, desc: 'x50 Global Yield' }
        ];

        function getDonationMult() { return 1 + (gameState.donations * 20); }
        function getNextPrestigeCost(level) { return 10000 * (level ** 2); }
        function getRequiredEXP(level) { return (level ** 2) * 1000; }

        async function init() {
            const saved = localStorage.getItem('cannaCultivatorSave');
            if(saved) {
                const loaded = JSON.parse(saved);
                // Ensure all properties exist
                gameState = Object.assign({}, gameState, loaded);
                // Backward compatibility for missing properties
                if (!gameState.currentStrain) gameState.currentStrain = 'ditch';
                if (!gameState.strainsOwned) gameState.strainsOwned = ['ditch'];
                if (!gameState.donations) gameState.donations = 0;
            }
            
            if(!gameState.playerName) {
                gameState.playerName = prompt("Enter your grower name:", "Grower") || "Grower";
            }
            
            document.getElementById('playerNameDisplay').innerText = gameState.playerName;
            renderShop(); 
            updateUI();
            
            // Initialize Supabase
            await initSupabase();
            
            // Initialize PayPal after a short delay
            setTimeout(initPayPal, 500);
            
            // Start game loop
            setInterval(gameLoop, 100);
            
            // Setup chat input
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if(e.key === 'Enter' && this.value.trim()) {
                    sendChatMessage(this.value.trim());
                    this.value = '';
                }
            });
        }
        
        async function initSupabase() {
            try {
                // First, register or update player
                await registerPlayer();
                
                // Load leaderboard
                await loadLeaderboard();
                
                // Load chat history
                await loadChatHistory();
                
                // Load purchase history
                await loadPurchases();
                
                // Set up real-time subscriptions
                setupRealtimeSubscriptions();
                
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showChatMessage('System: Leaderboard offline - using local data', 'system');
            }
        }
        
        async function registerPlayer() {
            try {
                const { data, error } = await supabase
                    .from('players')
                    .upsert({
                        player_id: playerId,
                        player_name: gameState.playerName,
                        grams: gameState.grams,
                        level: gameState.level,
                        prestige_level: gameState.prestigeLevel,
                        last_active: new Date().toISOString()
                    }, { onConflict: 'player_id' });
                    
                if (error) throw error;
            } catch (error) {
                console.error('Error registering player:', error);
            }
        }
        
        async function updatePlayerStats() {
            try {
                const { error } = await supabase
                    .from('players')
                    .upsert({
                        player_id: playerId,
                        player_name: gameState.playerName,
                        grams: gameState.grams,
                        level: gameState.level,
                        prestige_level: gameState.prestigeLevel,
                        total_harvested: gameState.totalHarvested,
                        last_active: new Date().toISOString()
                    }, { onConflict: 'player_id' });
                    
                if (error) throw error;
            } catch (error) {
                console.error('Error updating player stats:', error);
            }
        }
        
        async function loadLeaderboard() {
            try {
                const { data, error } = await supabase
                    .from('players')
                    .select('player_id, player_name, grams, level, prestige_level')
                    .order('grams', { ascending: false })
                    .limit(10);
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    updateLeaderboardUI(data);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }
        
        function updateLeaderboardUI(players) {
            const leaderboardDiv = document.getElementById('leaderboard');
            let html = '';
            
            players.forEach((player, index) => {
                const isYou = player.player_id === playerId;
                const rank = index + 1;
                const rowClass = isYou ? 'leaderboard-item you-row' : 'leaderboard-item';
                
                html += `
                    <div class="${rowClass}">
                        <b>#${rank} ${player.player_name.toUpperCase()}</b>
                        <div class="lb-stats">
                            <span>Lvl ${player.level}</span>
                            <span>${formatNum(player.grams)}g</span>
                        </div>
                    </div>
                `;
            });
            
            leaderboardDiv.innerHTML = html;
        }
        
        async function loadChatHistory() {
            try {
                const { data, error } = await supabase
                    .from('chat')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const chatBox = document.getElementById('chat-box');
                    data.reverse().forEach(message => {
                        const className = message.player_id === playerId ? 'user' : 'other';
                        if (message.player_id === 'system') {
                            chatBox.innerHTML += `<div class="chat-message system">${message.message}</div>`;
                        } else {
                            chatBox.innerHTML += `<div class="chat-message ${className}"><b>${message.player_name}:</b> ${message.message}</div>`;
                        }
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
        
        async function sendChatMessage(message) {
            try {
                const { error } = await supabase
                    .from('chat')
                    .insert({
                        player_id: playerId,
                        player_name: gameState.playerName,
                        message: message
                    });
                    
                if (error) throw error;
            } catch (error) {
                console.error('Error sending chat message:', error);
                // Fallback: show message locally
                showChatMessage(`${gameState.playerName}: ${message}`, 'user');
            }
        }
        
        function showChatMessage(message, type = 'system') {
            const chatBox = document.getElementById('chat-box');
            const className = type === 'system' ? 'system' : (type === 'user' ? 'user' : 'other');
            chatBox.innerHTML += `<div class="chat-message ${className}">${message}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Limit messages to 50
            const messages = chatBox.querySelectorAll('.chat-message');
            if (messages.length > 50) {
                messages[0].remove();
            }
        }
        
        async function loadPurchases() {
            try {
                const { data, error } = await supabase
                    .from('purchases')
                    .select('*')
                    .eq('player_id', playerId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                    
                if (error) throw error;
                
                // Update donations count from purchases
                if (data && data.length > 0) {
                    const donationPurchases = data.filter(p => p.item_type === 'donation');
                    gameState.donations = donationPurchases.length;
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading purchases:', error);
            }
        }
        
        async function recordPurchase(itemType, itemName, itemCost) {
            try {
                const { error } = await supabase
                    .from('purchases')
                    .insert({
                        player_id: playerId,
                        player_name: gameState.playerName,
                        item_type: itemType,
                        item_name: itemName,
                        item_cost: itemCost
                    });
                    
                if (error) throw error;
            } catch (error) {
                console.error('Error recording purchase:', error);
            }
        }
        
        function setupRealtimeSubscriptions() {
            // Leaderboard updates
            leaderboardSubscription = supabase
                .channel('leaderboard-updates')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'players' }, 
                    () => loadLeaderboard()
                )
                .subscribe();
            
            // Chat updates
            chatSubscription = supabase
                .channel('chat-updates')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'chat' }, 
                    (payload) => {
                        const newMessage = payload.new;
                        if (newMessage.player_id !== playerId) {
                            if (newMessage.player_id === 'system') {
                                showChatMessage(newMessage.message, 'system');
                            } else {
                                showChatMessage(`<b>${newMessage.player_name}:</b> ${newMessage.message}`, 'other');
                            }
                        }
                    }
                )
                .subscribe();
            
            // Purchase updates (for this player only)
            purchasesSubscription = supabase
                .channel('purchase-updates')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'purchases', filter: `player_id=eq.${playerId}` }, 
                    (payload) => {
                        const purchase = payload.new;
                        if (purchase.item_type === 'donation') {
                            gameState.donations++;
                            updateUI();
                            showChatMessage(`System: ${gameState.playerName} purchased a permanent x20 boost!`, 'system');
                        }
                    }
                )
                .subscribe();
        }

        function initPayPal() {
            if (typeof paypal === 'undefined') {
                console.error('PayPal SDK not loaded');
                return;
            }
            
            try {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: '4.99'
                                }
                            }]
                        });
                    },
                    onApprove: async function(data, actions) {
                        return actions.order.capture().then(async function(details) {
                            // Record the purchase in Supabase
                            await recordPurchase('donation', 'Permanent x20 Boost', 4.99);
                            
                            // Update local state
                            gameState.donations++;
                            updateUI();
                            
                            // Show system message
                            showChatMessage('System: Thank you for your donation! Permanent x20 boost applied!', 'system');
                            
                            // Alert the user
                            alert('Thank you for your donation! Permanent x20 boost applied!');
                        });
                    }
                }).render('#paypal-button-container');
            } catch (error) {
                console.error('PayPal initialization error:', error);
            }
        }

        function clickPlant(e) {
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * (1 + (gameState.level * 0.05)) * getDonationMult();
            const amount = 1 * gameState.multipliers.tap * totalMult;
            gameState.grams += amount; 
            gameState.exp += 10;
            gameState.totalHarvested += amount;
            
            const float = document.createElement('div'); 
            float.className = 'floating-num'; 
            float.innerText = `+${formatNum(amount)}g`;
            float.style.left = `${e.clientX}px`; 
            float.style.top = `${e.clientY}px`;
            document.body.appendChild(float); 
            setTimeout(() => float.remove(), 800);
            
            updateUI();
        }

        function updateUI() {
            const levelMult = 1 + (gameState.level * 0.05);
            const donateMult = getDonationMult();
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * levelMult * donateMult;
            const hps = (gameState.crew.trimmers.count * 1 + gameState.crew.growers.count * 5) * gameState.multipliers.auto * totalMult;
            
            document.getElementById('coinsDisplay').innerText = `${formatNum(gameState.grams)} Grams`;
            document.getElementById('count-trimmers').innerText = gameState.crew.trimmers.count;
            document.getElementById('count-growers').innerText = gameState.crew.growers.count;
            document.getElementById('hpsDisplay').innerText = `${formatNum(hps)}g/sec`;
            document.getElementById('hpcDisplay').innerText = `${formatNum(1 * gameState.multipliers.tap * totalMult)}g/click`;
            document.getElementById('prestigeMult').innerText = formatNum(gameState.prestigeLevel * donateMult);
            document.getElementById('stackCount').innerText = gameState.donations;
            
            const reqExp = getRequiredEXP(gameState.level);
            document.getElementById('levelDisplay').innerText = gameState.level;
            document.getElementById('expBar').style.width = `${(gameState.exp / reqExp) * 100}%`;
            document.getElementById('expText').innerText = `${formatNum(gameState.exp)} / ${formatNum(reqExp)} EXP`;
            
            // Update prestige button state
            const prestigeCost = getNextPrestigeCost(gameState.prestigeLevel);
            const prestigeBtn = document.getElementById('prestigeBtn');
            prestigeBtn.disabled = gameState.grams < prestigeCost;
            if (!prestigeBtn.disabled) {
                prestigeBtn.textContent = `Buy Max Prestige (${formatNum(prestigeCost)}g)`;
            } else {
                prestigeBtn.textContent = `Need ${formatNum(prestigeCost)}g`;
            }
            
            // Update all shop items
            renderShop();
            
            // Update player stats in Supabase (debounced)
            debouncedUpdatePlayerStats();
        }
        
        // Debounce function to prevent too many updates
        let updateTimeout;
        function debouncedUpdatePlayerStats() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                updatePlayerStats();
            }, 2000); // Update every 2 seconds max
        }

        function renderShop() {
            // Crew buttons
            document.getElementById('crewButtons').innerHTML = Object.keys(gameState.crew).map(id => {
                const c = gameState.crew[id];
                const canAfford = gameState.grams >= c.cost;
                return `<div class="upgrade-item"><b>${id.charAt(0).toUpperCase() + id.slice(1)}</b><button onclick="buyCrew('${id}')" ${!canAfford ? 'disabled' : ''}>Hire (${formatNum(c.cost)}g)</button></div>`;
            }).join('');
            
            // Upgrades
            document.getElementById('shopList').innerHTML = upgrades.map((up, i) => {
                const owned = gameState.upgrades.includes(up.id);
                const canAfford = gameState.grams >= up.cost;
                const disabled = owned || !canAfford;
                return `<div class="upgrade-item"><b>${up.name}</b><span class="bonus-info">${up.desc}</span><button onclick="buyUpgrade(${i})" ${disabled ? 'disabled' : ''}>${owned ? 'OWNED' : canAfford ? 'Buy (' + formatNum(up.cost) + 'g)' : 'Need ' + formatNum(up.cost) + 'g'}</button></div>`;
            }).join('');
            
            // Strains
            document.getElementById('strainList').innerHTML = strains.map((st, i) => {
                const owned = gameState.strainsOwned.includes(st.id);
                const isActive = gameState.currentStrain === st.id;
                const canAfford = gameState.grams >= st.cost;
                const className = isActive ? 'upgrade-item active-strain' : 'upgrade-item';
                const disabled = owned || !canAfford;
                
                let buttonText;
                if (owned) {
                    buttonText = isActive ? 'ACTIVE' : 'ACTIVATE';
                } else {
                    buttonText = canAfford ? 'Buy (' + formatNum(st.cost) + 'g)' : 'Need ' + formatNum(st.cost) + 'g';
                }
                
                return `<div class="${className}"><b>${st.name}</b><span class="bonus-info">${st.desc}</span><button onclick="buyStrain(${i})" ${disabled ? 'disabled' : ''}>${buttonText}</button></div>`;
            }).join('');
        }

        async function buyUpgrade(i) {
            if(gameState.grams >= upgrades[i].cost) {
                gameState.grams -= upgrades[i].cost; 
                gameState.upgrades.push(upgrades[i].id);
                
                if(upgrades[i].type === 'tap') gameState.multipliers.tap *= upgrades[i].bonus;
                if(upgrades[i].type === 'auto') gameState.multipliers.auto *= upgrades[i].bonus;
                
                // Record purchase
                await recordPurchase('upgrade', upgrades[i].name, upgrades[i].cost);
                
                updateUI();
            }
        }

        async function buyStrain(i) {
            if(gameState.grams >= strains[i].cost) {
                gameState.grams -= strains[i].cost; 
                if (!gameState.strainsOwned.includes(strains[i].id)) {
                    gameState.strainsOwned.push(strains[i].id);
                }
                gameState.currentStrain = strains[i].id;
                gameState.multipliers.strain = strains[i].mult;
                
                // Record purchase
                await recordPurchase('strain', strains[i].name, strains[i].cost);
                showChatMessage(`System: ${gameState.playerName} unlocked ${strains[i].name}!`, 'system');
                
                updateUI();
            }
        }

        async function buyCrew(id) {
            if(gameState.grams >= gameState.crew[id].cost) {
                gameState.grams -= gameState.crew[id].cost; 
                gameState.crew[id].count++;
                gameState.crew[id].cost = Math.floor(gameState.crew[id].cost * 1.25);
                
                // Record purchase
                await recordPurchase('crew', id, gameState.crew[id].cost);
                
                updateUI();
            }
        }

        async function prestigeMax() {
            const cost = getNextPrestigeCost(gameState.prestigeLevel);
            if(gameState.grams >= cost) {
                gameState.grams -= cost;
                gameState.prestigeLevel++;
                
                // Record purchase
                await recordPurchase('prestige', 'Prestige Level ' + gameState.prestigeLevel, cost);
                showChatMessage(`System: ${gameState.playerName} reached Prestige Level ${gameState.prestigeLevel}!`, 'system');
                
                alert(`Prestige level ${gameState.prestigeLevel} achieved! Multiplier increased!`);
                updateUI();
            } else {
                alert(`Need ${formatNum(cost)}g for next prestige!`);
            }
        }

        function gameLoop() {
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * (1 + (gameState.level * 0.05)) * getDonationMult();
            const hps = (gameState.crew.trimmers.count * 1 + gameState.crew.growers.count * 5) * gameState.multipliers.auto * totalMult;
            gameState.grams += hps / 10;
            gameState.totalHarvested += hps / 10;
            
            // Check for level up
            if(gameState.exp >= getRequiredEXP(gameState.level)) { 
                gameState.exp = 0; 
                gameState.level++; 
                showChatMessage(`System: ${gameState.playerName} reached Level ${gameState.level}!`, 'system');
            }
            
            updateUI();
        }

        function resetGame() { 
            if(confirm("Are you sure you want to wipe your save?")) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }

        // Event listeners
        document.getElementById('clickArea').addEventListener('click', clickPlant);
        
        // Auto-save every 5 seconds
        setInterval(() => {
            localStorage.setItem('cannaCultivatorSave', JSON.stringify(gameState));
        }, 5000);
        
        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
