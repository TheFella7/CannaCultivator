<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator - Live Edition</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AZawPulf_LA1GNqlqUE_L6PC4UqJsan33_c5L9wEcOLTRK1itpzK1QrSwueuFyPlbaEV7U0JejX_Vd70&currency=GBP"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; border: 3px solid #4caf50; }
        .header { text-align: center; border-bottom: 3px solid #4caf50; margin-bottom: 20px; padding-bottom: 10px; }
        .game-title { font-size: 2.5rem; color: #76ff03; text-shadow: 2px 2px 0 #1b3012; }
        .exp-container { width: 100%; background: #1b3012; height: 15px; border-radius: 10px; margin-top: 5px; overflow: hidden; border: 1px solid #4caf50; }
        .exp-bar { height: 100%; background: #76ff03; width: 0%; transition: width 0.3s; }
        .game-area { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-garden { flex: 2; min-width: 280px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        .click-area { width: 200px; height: 200px; margin: 20px auto; background: radial-gradient(circle, rgba(118, 255, 3, 0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 100px; user-select: none; transition: transform 0.05s; }
        .click-area:active { transform: scale(0.95); }
        .coins-display { font-size: 2.2em; color: #fff; text-shadow: 2px 2px 0 #000; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #388e3c; }
        .upgrade-item { background: rgba(60, 90, 40, 0.4); padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #4caf50; }
        button { background: linear-gradient(to bottom, #4caf50, #2e7d32); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .floating-num { position: absolute; color: #76ff03; font-weight: bold; pointer-events: none; animation: floatUp 0.8s forwards; font-size: 1.5rem; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
            <p>Grower: <span id="playerNameDisplay" style="color:#76ff03">...</span> | Lvl <span id="levelDisplay">1</span></p>
            <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
        </div>
        
        <div class="game-area">
            <div class="main-garden">
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <p id="hpsDisplay" style="color:#aed581">0g/sec</p>
                
                <div style="margin-top:20px; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px; border:1px solid #ffc107;">
                    <p style="font-weight:bold; color:#ffc107;">PERMANENT x20 BOOST</p>
                    <div id="paypal-button-container" style="margin-top:10px;"></div>
                </div>
            </div>
            
            <div class="stats-sidebar">
                <h3 style="color:#76ff03; border-bottom:1px solid #4caf50; margin-bottom:10px;">Leaderboard</h3>
                <div id="leaderboard" class="leaderboard-list">Loading...</div>
            </div>
            
            <div class="upgrades-shop">
                <h3 style="color:#76ff03; border-bottom:1px solid #4caf50; margin-bottom:10px;">Equipment</h3>
                <div id="shopList"></div>
                <button onclick="resetGame()" style="background:#7d2e2e; margin-top:20px; font-size:0.7em;">Wipe Save</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SB_KEY = 'EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let gameState = {
            playerName: "", grams: 0, level: 1, exp: 0, donations: 0,
            trimmers: 0, trimmerCost: 20
        };

        function formatNum(num) { return Math.floor(num).toLocaleString(); }

        async function init() {
            const saved = localStorage.getItem('cannaSave_v2');
            if(saved) gameState = Object.assign(gameState, JSON.parse(saved));
            if(!gameState.playerName) gameState.playerName = prompt("Enter Grower Name:") || "Grower" + Math.floor(Math.random()*999);
            document.getElementById('playerNameDisplay').innerText = gameState.playerName;
            
            updateUI();
            gameLoop();
            initPayPal();
            fetchLeaderboard();
            setInterval(syncData, 10000);
            setInterval(fetchLeaderboard, 15000);
        }

        async function fetchLeaderboard() {
            try {
                const { data } = await supabaseClient.from('players').select('*').order('total_grams', { ascending: false }).limit(8);
                if(data) {
                    document.getElementById('leaderboard').innerHTML = data.map((p, i) => `
                        <div class="leaderboard-item">
                            <span>#${i+1} ${p.player_name}</span>
                            <b>${formatNum(p.total_grams)}g</b>
                        </div>
                    `).join('');
                }
            } catch(e) { console.error("Leaderboard error"); }
        }

        async function syncData() {
            await supabaseClient.from('players').upsert({ 
                player_name: gameState.playerName, 
                total_grams: Math.floor(gameState.grams),
                player_level: gameState.level
            }, { onConflict: 'player_name' });
        }

        function initPayPal() {
            paypal.Buttons({
                createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: '4.99' } }] }),
                onApprove: (data, actions) => actions.order.capture().then(() => { 
                    gameState.donations++; 
                    updateUI(); 
                })
            }).render('#paypal-button-container');
        }

        function clickPlant(e) {
            const power = (1 + (gameState.donations * 20));
            gameState.grams += power;
            gameState.exp += 10;
            
            const float = document.createElement('div');
            float.className = 'floating-num';
            float.innerText = `+${power}`;
            float.style.left = e.pageX + 'px';
            float.style.top = e.pageY + 'px';
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 800);
            updateUI();
        }

        function updateUI() {
            document.getElementById('coinsDisplay').innerText = formatNum(gameState.grams) + " Grams";
            document.getElementById('hpsDisplay').innerText = (gameState.trimmers * (1 + (gameState.donations * 20))) + "g/sec";
            
            let req = gameState.level * 1000;
            if(gameState.exp >= req) { gameState.exp = 0; gameState.level++; }
            document.getElementById('levelDisplay').innerText = gameState.level;
            document.getElementById('expBar').style.width = (gameState.exp / req * 100) + "%";
            
            document.getElementById('shopList').innerHTML = `
                <div class="upgrade-item">
                    <p>Auto-Trimmer (1g/s)</p>
                    <button onclick="buyTrimmer()">Hire (${formatNum(gameState.trimmerCost)}g)</button>
                </div>
            `;
            localStorage.setItem('cannaSave_v2', JSON.stringify(gameState));
        }

        function buyTrimmer() {
            if(gameState.grams >= gameState.trimmerCost) {
                gameState.grams -= gameState.trimmerCost;
                gameState.trimmers++;
                gameState.trimmerCost = Math.floor(gameState.trimmerCost * 1.4);
                updateUI();
            }
        }

        function gameLoop() {
            gameState.grams += (gameState.trimmers / 10) * (1 + (gameState.donations * 20));
            updateUI();
            setTimeout(gameLoop, 100);
        }

        function resetGame() { if(confirm("Wipe all progress?")) { localStorage.clear(); location.reload(); } }
        document.getElementById('clickArea').addEventListener('click', clickPlant);
        window.onload = init;
    </script>
</body>
</html>
