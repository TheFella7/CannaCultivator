<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator - Live Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=GBP"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 10px; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 3px solid #4caf50; }
        .header { text-align: center; padding: 10px; border-bottom: 3px solid #4caf50; margin-bottom: 20px; }
        .game-title { font-size: clamp(1.8rem, 5vw, 3rem); color: #76ff03; text-shadow: 2px 2px 0 #1b3012; margin-bottom: 5px; }
        .exp-container { width: 100%; background: #1b3012; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #4caf50; }
        .exp-bar { height: 100%; background: linear-gradient(90deg, #76ff03, #4caf50); width: 0%; transition: width 0.3s; }
        .game-area { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-garden { flex: 2; min-width: 280px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        .section-title { color: #76ff03; font-size: 1.5em; margin-bottom: 15px; border-bottom: 1px solid #4caf50; padding-bottom: 5px; }
        .click-area { width: 200px; height: 200px; margin: 20px auto; background: radial-gradient(circle, rgba(118, 255, 3, 0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.05s; position: relative; font-size: 100px; user-select: none; }
        .click-area:active { transform: scale(0.92); }
        .coins-display { font-size: 2.2em; color: #fff; margin: 10px 0; text-shadow: 2px 2px 0 #000; }
        .herb-count { color: #aed581; font-weight: bold; margin: 5px 0; }
        .upgrade-item { background: rgba(60, 90, 40, 0.4); padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #4caf50; }
        button { background: linear-gradient(to bottom, #4caf50, #2e7d32); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; transition: 0.2s; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .floating-num { position: absolute; color: #76ff03; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 1000; text-shadow: 1px 1px 2px black; font-size: 1.5rem; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120px); opacity: 0; } }
        #chat-box { height: 180px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-top: 10px; padding: 8px; overflow-y: auto; font-size: 0.85em; border: 1px solid #388e3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
            <p>Welcome, <span id="playerNameDisplay" style="color:#76ff03">Grower</span>!</p>
            <div>
                <span>Player Level: <b id="levelDisplay">1</b></span>
                <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
                <small id="expText">0 / 1,000 EXP</small>
            </div>
        </div>
        
        <div class="game-area">
            <div class="main-garden">
                <h2 class="section-title">Cultivation</h2>
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <p class="herb-count" id="hpcDisplay">1g/click</p>
                <p class="herb-count" id="hpsDisplay">0g/sec</p>

                <div class="prestige-box">
                    <div style="color:#76ff03; font-weight: bold;">Mastery Multiplier: x<span id="prestigeMult">1</span></div>
                    <button id="prestigeBtn" onclick="buyMaxPrestige()">Buy Max Prestige (Cost: <span id="prestigeCost">1k</span>g)</button>
                </div>
                
                <div id="paypal-button-container" style="margin-top:20px;"></div>
            </div>
            
            <div class="stats-sidebar">
                <h2 class="section-title">Leaderboard</h2>
                <div id="leaderboard">Connect Supabase to see rankings...</div>
                
                <h2 class="section-title" style="margin-top:20px;">Global Chat</h2>
                <div id="chat-box">Offline Mode</div>
                <input type="text" id="chatInput" placeholder="Press Enter to chat...">

                <h2 class="section-title" style="margin-top:20px;">The Crew</h2>
                <div id="crewButtons"></div>
            </div>
            
            <div class="upgrades-shop">
                <h2 class="section-title">Strains & Supplies</h2>
                <div id="strainList"></div>
                <div id="shopList"></div>
                <button onclick="resetGame()" style="background: #7d2e2e; margin-top: 20px;">Wipe Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: ADD YOUR KEYS HERE ---
        const SB_URL = ''; 
        const SB_KEY = '';
        const supabase = (SB_URL && SB_KEY) ? supabase.createClient(SB_URL, SB_KEY) : null;

        let gameState = {
            playerName: "", grams: 0, prestigeLevel: 1, level: 1, exp: 0, donations: 0,
            multipliers: { tap: 1, auto: 1, strain: 1 },
            crew: { trimmers: { count: 0, cost: 20, power: 1 }, growers: { count: 0, cost: 150, power: 5 } },
            upgrades: [], strainsOwned: ['ditch']
        };

        const upgrades = [
            { id: 'shears', name: 'Sharp Shears', cost: 100, bonus: 2, type: 'tap', desc: 'x2 Tap Yield' },
            { id: 'lights', name: 'LED Lights', cost: 500, bonus: 1.5, type: 'auto', desc: 'x1.5 Auto Yield' }
        ];

        const strains = [
            { id: 'skunk', name: 'Skunk #1', cost: 1000, mult: 2, desc: 'x2 Global Yield' },
            { id: 'haze', name: 'Purple Haze', cost: 5000, mult: 5, desc: 'x5 Global Yield' }
        ];

        function formatNum(num) {
            if (num < 1000) return Math.floor(num).toLocaleString();
            const suffixes = ["", "k", "m", "b", "t"];
            const exp = Math.floor(Math.log10(num) / 3);
            return (num / Math.pow(10, exp * 3)).toFixed(2) + suffixes[exp];
        }

        function getRequiredEXP(level) { return (level ** 2) * 1000; }
        function getPrestigeCost() { return 1000 * Math.pow(2, gameState.prestigeLevel - 1); }

        function init() {
            const saved = localStorage.getItem('cannaCultivatorSave');
            if(saved) {
                const loaded = JSON.parse(saved);
                gameState = { ...gameState, ...loaded };
            }
            if(!gameState.playerName) gameState.playerName = prompt("Grower Name:", "BigBud") || "BigBud";
            document.getElementById('playerNameDisplay').innerText = gameState.playerName;
            
            renderShop();
            gameLoop();
            if(supabase) initLiveFeatures();
        }

        function clickPlant(e) {
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * (1 + (gameState.level * 0.1)) * (1 + (gameState.donations * 20));
            const amount = 1 * gameState.multipliers.tap * totalMult;
            gameState.grams += amount; 
            gameState.exp += 10;
            
            const float = document.createElement('div'); 
            float.className = 'floating-num'; 
            float.innerText = `+${formatNum(amount)}g`;
            float.style.left = `50%`; 
            float.style.top = `50%`;
            e.target.appendChild(float);
            setTimeout(() => float.remove(), 800);
            
            updateUI();
        }

        function buyMaxPrestige() {
            let cost = getPrestigeCost();
            while (gameState.grams >= cost) {
                gameState.grams -= cost;
                gameState.prestigeLevel++;
                cost = getPrestigeCost();
            }
            updateUI();
        }

        function buyCrew(id) {
            let c = gameState.crew[id];
            if(gameState.grams >= c.cost) {
                gameState.grams -= c.cost;
                c.count++;
                c.cost = Math.floor(c.cost * 1.25);
                renderShop();
                updateUI();
            }
        }

        function updateUI() {
            const donationMult = 1 + (gameState.donations * 20);
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * (1 + (gameState.level * 0.1)) * donationMult;
            const hps = (gameState.crew.trimmers.count * 1 + gameState.crew.growers.count * 5) * gameState.multipliers.auto * totalMult;
            
            document.getElementById('coinsDisplay').innerText = `${formatNum(gameState.grams)} Grams`;
            document.getElementById('hpsDisplay').innerText = `${formatNum(hps)}g/sec`;
            document.getElementById('hpcDisplay').innerText = `${formatNum(1 * gameState.multipliers.tap * totalMult)}g/click`;
            document.getElementById('prestigeMult').innerText = gameState.prestigeLevel * donationMult;
            document.getElementById('prestigeCost').innerText = formatNum(getPrestigeCost());
            
            const reqExp = getRequiredEXP(gameState.level);
            document.getElementById('levelDisplay').innerText = gameState.level;
            document.getElementById('expBar').style.width = `${Math.min(100, (gameState.exp / reqExp) * 100)}%`;
            document.getElementById('expText').innerText = `${formatNum(gameState.exp)} / ${formatNum(reqExp)} EXP`;
        }

        function renderShop() {
            document.getElementById('crewButtons').innerHTML = Object.keys(gameState.crew).map(id => `
                <div class="upgrade-item">
                    <b>${id.toUpperCase()}</b> (x${gameState.crew[id].count})
                    <button onclick="buyCrew('${id}')">Hire (${formatNum(gameState.crew[id].cost)}g)</button>
                </div>
            `).join('');
            
            document.getElementById('shopList').innerHTML = upgrades.map((up, i) => {
                const owned = gameState.upgrades.includes(up.id);
                return `<div class="upgrade-item"><b>${up.name}</b><br><button onclick="buyUpgrade(${i})" ${owned ? 'disabled' : ''}>${owned ? 'OWNED' : 'Buy (' + formatNum(up.cost) + 'g)'}</button></div>`;
            }).join('');
        }

        function buyUpgrade(i) {
            if(gameState.grams >= upgrades[i].cost && !gameState.upgrades.includes(upgrades[i].id)) {
                gameState.grams -= upgrades[i].cost;
                gameState.upgrades.push(upgrades[i].id);
                if(upgrades[i].type === 'tap') gameState.multipliers.tap *= upgrades[i].bonus;
                if(upgrades[i].type === 'auto') gameState.multipliers.auto *= upgrades[i].bonus;
                renderShop();
            }
        }

        function gameLoop() {
            const donationMult = 1 + (gameState.donations * 20);
            const totalMult = gameState.multipliers.strain * gameState.prestigeLevel * (1 + (gameState.level * 0.1)) * donationMult;
            const hps = (gameState.crew.trimmers.count * 1 + gameState.crew.growers.count * 5) * gameState.multipliers.auto * totalMult;
            
            gameState.grams += hps / 10;
            if(gameState.exp >= getRequiredEXP(gameState.level)) {
                gameState.exp -= getRequiredEXP(gameState.level);
                gameState.level++;
            }
            
            updateUI();
            saveGame();
            setTimeout(gameLoop, 100);
        }

        function saveGame() { localStorage.setItem('cannaCultivatorSave', JSON.stringify(gameState)); }
        function resetGame() { if(confirm("Wipe all progress?")) { localStorage.clear(); location.reload(); } }

        document.getElementById('clickArea').addEventListener('click', clickPlant);
        window.onload = init;
    </script>
</body>
</html>
