<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canna Cultivator - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=GBP"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #1a2e0e 0%, #2d5016 100%); color: #f0f7da; min-height: 100vh; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(20, 30, 15, 0.9); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 3px solid #4caf50; }
        .header { text-align: center; padding: 10px; border-bottom: 3px solid #4caf50; margin-bottom: 20px; }
        .game-title { font-size: clamp(1.8rem, 5vw, 3rem); color: #76ff03; text-shadow: 2px 2px 0 #1b3012; margin-bottom: 5px; }
        .exp-container { width: 100%; background: #1b3012; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #4caf50; }
        .exp-bar { height: 100%; background: linear-gradient(90deg, #76ff03, #4caf50); width: 0%; transition: width 0.3s; }
        .game-area { display: flex; flex-wrap: wrap; gap: 20px; }
        .main-garden { flex: 2; min-width: 280px; background: rgba(45, 70, 35, 0.5); border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #4caf50; }
        .stats-sidebar, .upgrades-shop { flex: 1; min-width: 250px; background: rgba(30, 45, 20, 0.7); border-radius: 15px; padding: 15px; border: 2px solid #388e3c; }
        .section-title { color: #76ff03; font-size: 1.5em; margin-bottom: 15px; border-bottom: 1px solid #4caf50; padding-bottom: 5px; }
        .click-area { width: clamp(200px, 40vw, 280px); height: clamp(200px, 40vw, 280px); margin: 10px auto; background: radial-gradient(circle, rgba(118, 255, 3, 0.2) 0%, rgba(0,0,0,0) 70%); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.05s; position: relative; font-size: 120px; user-select: none; }
        .click-area:active { transform: scale(0.92); }
        .coins-display { font-size: 2.2em; color: #fff; margin: 5px 0; text-shadow: 2px 2px 0 #000; }
        .herb-count { color: #aed581; font-weight: bold; margin: 5px 0; }
        .tap-stat { background: rgba(118, 255, 3, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; color: #76ff03; font-weight: bold; margin-bottom: 10px; border: 1px solid #76ff03; }
        .upgrade-item { background: rgba(60, 90, 40, 0.4); padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #4caf50; }
        .prestige-box { background: rgba(118, 255, 3, 0.1); border: 2px dashed #76ff03; padding: 15px; margin-top: 15px; border-radius: 10px; text-align: center; }
        button { background: linear-gradient(to bottom, #4caf50, #2e7d32); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #444; }
        .purchased-badge { color: #76ff03; font-weight: bold; font-style: italic; font-size: 0.9em; }
        #chat-box { height: 150px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-top: 10px; padding: 5px; overflow-y: auto; font-size: 0.8em; border: 1px solid #388e3c; }
        .leaderboard-item { display: flex; flex-direction: column; padding: 8px; border-bottom: 1px solid #388e3c; }
        .you-row { color: #76ff03; font-weight: bold; background: rgba(118, 255, 3, 0.1); border: 1px solid #76ff03; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="game-title">ðŸŒ¿ Canna Cultivator</h1>
            <p>Grower: <span id="playerNameDisplay" style="color:#76ff03">Loading...</span></p>
            <div style="margin-top: 10px;">
                <span>Level: <b id="levelDisplay">1</b></span>
                <div class="exp-container"><div class="exp-bar" id="expBar"></div></div>
                <small id="expText">0 / 1,000 EXP</small>
            </div>
        </div>

        <div class="game-area">
            <div class="main-garden">
                <h2 class="section-title">Cultivation</h2>
                <div class="tap-stat">Tap: +<span id="tapEarned">1</span>g</div>
                <div class="click-area" id="clickArea">ðŸŒ¿</div>
                <div class="coins-display" id="coinsDisplay">0 Grams</div>
                <p class="herb-count" id="hpsDisplay">0g/sec</p>
                
                <div class="prestige-box">
                    <div style="color:#76ff03; font-weight: bold;">Mastery: x<span id="prestigeMult">1</span></div>
                    <button id="prestigeBtn" onclick="buyMaxPrestige()">Buy Max Mastery</button>
                    
                    <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.4); border-radius:10px; border:1px solid #ffc107;">
                        <p style="color:#fff; font-size:0.8em; font-weight:bold;">x20 BOOST (DONATION)</p>
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>

            <div class="stats-sidebar">
                <h2 class="section-title">Leaderboard</h2>
                <div id="leaderboard" class="leaderboard-list"></div>

                <h2 class="section-title" style="margin-top:20px;">Global Chat</h2>
                <div id="chat-box"></div>
                <input type="text" id="chatInput" placeholder="Press Enter to chat..." style="width:100%; background:#1b3012; border:1px solid #4caf50; color:#fff; padding:5px; margin-top:5px; border-radius:5px;">

                <h2 class="section-title" style="margin-top:20px;">The Crew</h2>
                <div id="crewButtons"></div>
            </div>

            <div class="upgrades-shop">
                <h2 class="section-title">Strains (Permanent)</h2>
                <div id="strainList"></div>

                <h2 class="section-title" style="margin-top:20px;">Supplies</h2>
                <div id="shopList"></div>
                
                <button onclick="resetAccount()" style="background: #7d2e2e; margin-top: 20px; font-size: 0.8em;">Change User / Logout</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://klcqhrajnhegzmzfdzji.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsY3FocmFqbmhlZ3ptemZkemppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTk1MjcsImV4cCI6MjA4MzAzNTUyN30.DhESHsa5cmHTvetWtEIBqGQHfiXml4eOpUteC8A-LAU';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let state = {
            name: "", grams: 0, level: 1, exp: 0, prestige: 1, donations: 0,
            crew: { trimmers: { n: 0, c: 20, p: 1 }, growers: { n: 0, c: 150, p: 5 } },
            upgrades: [], strains: [] 
        };

        const staticData = {
            upgrades: [
                { id: 'shears', name: 'Sharp Shears', cost: 100, x: 2, type: 'tap' },
                { id: 'lights', name: 'LED Lights', cost: 500, x: 1.5, type: 'auto' },
                { id: 'hydro', name: 'Hydroponics', cost: 2000, x: 3, type: 'auto' }
            ],
            strains: [
                { id: 'skunk', name: 'Skunk #1', cost: 1000, x: 2 },
                { id: 'haze', name: 'Purple Haze', cost: 5000, x: 5 },
                { id: 'kush', name: 'OG Kush', cost: 25000, x: 10 }
            ]
        };

        function getMults() {
            let tap = 1, auto = 1, sMult = 1;
            state.strains.forEach(id => { const s = staticData.strains.find(x => x.id === id); if(s) sMult *= s.x; });
            state.upgrades.forEach(id => { 
                const u = staticData.upgrades.find(x => x.id === id);
                if(u) { if(u.type === 'tap') tap *= u.x; else auto *= u.x; }
            });
            const global = sMult * state.prestige * (1 + (state.level * 0.05)) * (1 + (state.donations * 20));
            return { tap: tap * global, auto: auto * global };
        }

        function calculateMax(currentCost, balance, factor = 1.25) {
            let count = 0;
            let totalCost = 0;
            let nextCost = currentCost;
            while (balance >= totalCost + nextCost) {
                totalCost += nextCost;
                nextCost = Math.floor(nextCost * factor);
                count++;
            }
            return { count, totalCost };
        }

        function updateUI() {
            const m = getMults();
            const hps = (state.crew.trimmers.n * state.crew.trimmers.p + state.crew.growers.n * state.crew.growers.p) * m.auto;
            
            document.getElementById('coinsDisplay').innerText = Math.floor(state.grams).toLocaleString() + " Grams";
            document.getElementById('hpsDisplay').innerText = hps.toLocaleString() + "g/sec";
            document.getElementById('tapEarned').innerText = m.tap.toLocaleString();
            document.getElementById('prestigeMult').innerText = state.prestige;

            // Update Mastery Button
            const pCost = 10000 * (state.prestige ** 2);
            const pMax = calculateMax(pCost, state.grams, 2.0); // Mastery costs more per level
            document.getElementById('prestigeBtn').innerText = pMax.count > 0 ? `Buy Max: +${pMax.count} (${pMax.totalCost.toLocaleString()}g)` : `Need: ${pCost.toLocaleString()}g`;
            document.getElementById('prestigeBtn').disabled = pMax.count === 0;

            // EXP Bar
            const req = (state.level ** 2) * 1000;
            document.getElementById('levelDisplay').innerText = state.level;
            document.getElementById('expBar').style.width = `${(state.exp / req) * 100}%`;
            document.getElementById('expText').innerText = `${Math.floor(state.exp).toLocaleString()} / ${req.toLocaleString()} EXP`;

            // Crew Buttons
            document.getElementById('crewButtons').innerHTML = Object.keys(state.crew).map(id => {
                const max = calculateMax(state.crew[id].c, state.grams, 1.25);
                return `
                <div class="upgrade-item">
                    <b>${id.toUpperCase()}</b> (${state.crew[id].n})
                    <button onclick="buyMaxCrew('${id}')" ${max.count === 0 ? 'disabled' : ''}>
                        ${max.count > 0 ? `Buy Max: +${max.count} (${max.totalCost.toLocaleString()}g)` : `Need: ${state.crew[id].c}g`}
                    </button>
                </div>`;
            }).join('');

            // Strains & Upgrades
            document.getElementById('strainList').innerHTML = staticData.strains.map(s => `
                <div class="upgrade-item"><b>${s.name} (x${s.x})</b>${state.strains.includes(s.id) ? '<br><span class="purchased-badge">PURCHASED</span>' : `<button onclick="buyStrain('${s.id}')" ${state.grams < s.cost ? 'disabled' : ''}>Buy Once: ${s.cost}g</button>`}</div>
            `).join('');

            document.getElementById('shopList').innerHTML = staticData.upgrades.map(u => `
                <div class="upgrade-item"><b>${u.name}</b>${state.upgrades.includes(u.id) ? '<br><span class="purchased-badge">OWNED</span>' : `<button onclick="buyUpgrade('${u.id}')" ${state.grams < u.cost ? 'disabled' : ''}>Buy: ${u.cost}g</button>`}</div>
            `).join('');
        }

        function buyMaxCrew(id) {
            const max = calculateMax(state.crew[id].c, state.grams, 1.25);
            if(max.count > 0) {
                state.grams -= max.totalCost;
                state.crew[id].n += max.count;
                for(let i=0; i<max.count; i++) state.crew[id].c = Math.floor(state.crew[id].c * 1.25);
                updateUI();
            }
        }

        function buyMaxPrestige() {
            const pCost = 10000 * (state.prestige ** 2);
            const max = calculateMax(pCost, state.grams, 2.0);
            if(max.count > 0) {
                state.grams -= max.totalCost;
                state.prestige += max.count;
                updateUI();
            }
        }

        function buyStrain(id) {
            const s = staticData.strains.find(x => x.id === id);
            if(!state.strains.includes(id) && state.grams >= s.cost) { state.grams -= s.cost; state.strains.push(id); updateUI(); }
        }

        function buyUpgrade(id) {
            const u = staticData.upgrades.find(x => x.id === id);
            if(!state.upgrades.includes(id) && state.grams >= u.cost) { state.grams -= u.cost; state.upgrades.push(id); updateUI(); }
        }

        async function init() {
            // Persistent Username Logic
            let savedName = localStorage.getItem('cannaUsername');
            if(!savedName) {
                savedName = prompt("Enter Grower Name:");
                if(!savedName) savedName = "User" + Math.floor(Math.random()*999);
                localStorage.setItem('cannaUsername', savedName);
            }
            state.name = savedName;
            document.getElementById('playerNameDisplay').innerText = state.name;

            // Load from Cloud
            const { data } = await sb.from('leaderboard').select('game_state').eq('player_name', state.name).single();
            if(data) state = data.game_state;

            // PayPal
            paypal.Buttons({
                createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '4.99' } }] }),
                onApprove: (d, a) => a.order.capture().then(() => { state.donations++; updateUI(); })
            }).render('#paypal-button-container');

            // Game Loops
            setInterval(() => {
                const m = getMults();
                const hps = (state.crew.trimmers.n * 1 + state.crew.growers.n * 5) * m.auto;
                state.grams += hps / 10;
                state.exp += (hps / 200);
                if(state.exp >= (state.level ** 2) * 1000) { state.exp -= (state.level ** 2) * 1000; state.level++; }
                updateUI();
            }, 100);

            setInterval(() => {
                sb.from('leaderboard').upsert({ player_name: state.name, grams: Math.floor(state.grams), game_state: state, player_level: state.level, last_active: new Date() });
            }, 1000);

            // Leaderboard Refresh
            setInterval(async () => {
                const { data } = await sb.from('leaderboard').select('player_name, player_level, grams').order('grams', {ascending:false}).limit(5);
                if(data) document.getElementById('leaderboard').innerHTML = data.map((p,i)=>`<div class="leaderboard-item ${p.player_name === state.name ? 'you-row' : ''}"><b>#${i+1} ${p.player_name}</b><div class="lb-stats"><span>Lvl ${p.player_level}</span><span>${Math.floor(p.grams).toLocaleString()}g</span></div></div>`).join('');
            }, 5000);

            document.getElementById('clickArea').onclick = () => { state.grams += getMults().tap; state.exp += 15 * state.prestige; updateUI(); };
            document.getElementById('chatInput').onkeypress = async e => {
                if(e.key === 'Enter' && e.target.value.trim()){
                    await sb.from('messages').insert([{player_name:state.name, message_text:e.target.value}]);
                    e.target.value = '';
                }
            };
            
            // Subscribe to Chat
            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                const box = document.getElementById('chat-box');
                box.innerHTML += `<div><b>${p.new.player_name}:</b> ${p.new.message_text}</div>`;
                box.scrollTop = box.scrollHeight;
            }).subscribe();
        }

        function resetAccount() { if(confirm("Logout and change user?")) { localStorage.removeItem('cannaUsername'); location.reload(); } }
        window.onload = init;
    </script>
</body>
</html>

